<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FAF ICE Adapter</title>
    <script type="module" src="https://unpkg.com/@freshworks/crayons@v3/dist/crayons/crayons.esm.js"></script>
    <script nomodule src="https://unpkg.com/@freshworks/crayons@v3/dist/crayons/crayons.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@freshworks/crayons@v3/css/crayons-min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css"
          integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w=="
          crossorigin="anonymous"/>
    <style>
        #main {
            max-width: 1000px;
            margin: 20px auto 20px auto;
        }

        .wrapper {
            margin-bottom: 1rem;
        }

        header {
            margin-bottom: 1rem;
            text-align: center;
        }

        h1 {
            font-family: sans-serif;
            margin-bottom: 0.5rem;
        }

        h1:before, h1:after {
            content: url('https://faforever.com/images/faf-logo.png');
            zoom: 0.10;
            padding-left: 5rem;
            padding-right: 5rem;
        }

        .explanation {
            text-align: justify;
        }

        ul.plain {
            list-style: none;
            padding-left: 0;
        }

        code {
            font-family: monospace;
            color: #c7254e;
            background-color: #f9f2f4;
        }

        li strong.indent-2 {
            display: inline-block;
            width: 2.2rem;
        }

        li strong.indent-3 {
            display: inline-block;
            width: 3rem;
        }

        footer {
            margin-top: 2rem;
            margin-bottom: 1rem;
            text-align: center;
            font-size: 0.9rem;
        }

        footer a {
            text-decoration: none;
            color: black;
        }

        footer p, ul {
            margin: 1rem 0 0 0;
            padding: 0;
            list-style-type: none;
        }

        footer ul li {
            display: inline-block;
            padding: 0;
        }

        fw-data-table {
            border: 1px solid darkgray;
        }
    </style>
</head>
<body>
<div id="main" class="fw-card-1">
    <header>
        <h1>ICE adapter UI</h1>

        <fw-pill color="gray">
            <fw-icon name="info" slot="icon"></fw-icon>
            UI Version : 0.1.0
        </fw-pill>
        <fw-pill color="grey">
            <fw-icon name="info" slot="icon" ></fw-icon>
            Adapter Version: unknown
        </fw-pill>
        <fw-pill color="grey">
            <fw-icon name="info" slot="icon" ></fw-icon>
            Protocol Version: v1
        </fw-pill>
        <fw-pill color="red">
            <fw-icon name="alert" slot="icon"></fw-icon>
            Could not connect to local adapter
        </fw-pill>
    </header>
    <main>
        <div class="wrapper">
            <fw-accordion expanded>
                <fw-accordion-title>Live ICE adapter state</fw-accordion-title>
                <fw-accordion-body>
                    <fw-pill color="blue">
                        <fw-icon name="info" slot="icon"></fw-icon>
                        Game ID : 4711
                    </fw-pill>
                    <fw-pill color="yellow">
                        <fw-icon name="add-contact" slot="icon"></fw-icon>
                        Game State : Connecting players
                    </fw-pill>
                    <fw-pill color="gray">
                        <fw-icon name="location" slot="icon"></fw-icon>
                        Your Coturn : coturn-eu-1.supcomhub.org
                    </fw-pill>
                    <fw-data-table id="connections-table" is-selectable="false" label="Peer connections">
                    </fw-data-table>
                </fw-accordion-body>
            </fw-accordion>
        </div>

        <div class="wrapper">
            <fw-accordion expanded>
                <fw-accordion-title>Coturn servers</fw-accordion-title>
                <fw-accordion-body>
                    <fw-data-table id="coturn-table" is-selectable="false" label="Peer connections">
                    </fw-data-table>
                </fw-accordion-body>
            </fw-accordion>
        </div>

        <div class="wrapper">
            <fw-accordion>
                <fw-accordion-title>What is the ICE adapter?</fw-accordion-title>
                <fw-accordion-body class="explanation">
                    <p>The FAF ICE adapter aims at managing all connections for the game. It's a program running on your
                        local system started/stopped by the FAF client that offers an interface to the game. The game is
                        then told by the FAF server/client/adapter to connect to other players, supplying it a wrong IP
                        address. If you then join a FAF game, your game will think all of your peers it's connected to
                        are located on your local machine. It sends all its traffic to the ice adapter, which then
                        figures out how to forward it to the other players' ice adapters, which then forward it to their
                        games.</p>

                    <p>The ICE adapter uses the <strong>Interactive Connectivity Establishment</strong> (ICE,
                        standardized as per <a href="https://datatracker.ietf.org/doc/html/rfc5245" target="_blank">RFC5254</a>)
                        to, well, interactively establish connections.</p>
                </fw-accordion-body>
            </fw-accordion>
        </div>

        <div class="wrapper">
            <fw-accordion>
                <fw-accordion-title>How does ICE work?</fw-accordion-title>
                <fw-accordion-body class="explanation">
                    <p>For each player you connect to, the ice adapter will run ICE to establish a connection. The
                        process can be broken down into the following steps:</p>

                    <ol>
                        <li>Gather candidates
                        <li>Send candidates to the other player's adapter via the FAF server
                        <li>Receive candidates from the other player's adapter via the FAF server
                        <li>Form pairs of candidates (one local candidate, one remote candidate for the other player)
                        <li>Try to reach the other player on all pairs (using the local address, sending to the remote
                            candidate)
                        <li>Pick best pair to succeeded, nominate, confirm (if failed, disable non relay candidates, go
                            to
                            step 1)
                        <li>Start communication
                        <li>(monitor connection, echo requests, once per second, restart on connection loss)
                    </ol>

                    <p>The following types of candidates exist (the last one is not relevant for FAF):</p>

                    <ul>
                        <li><strong class="indent-3">HOST:</strong> a candidate obtained from a local interface, this is
                            an
                            IP address
                            someone in your own network can reach you at (for local connections)
                        <li><strong class="indent-3">SRFLX:</strong> server reflexive - a candidate obtained by asking a
                            STUN <small>(session traversal utilities for NAT)</small> server, where do you see this
                            request coming from - usually your “public IP”
                        <li><strong class="indent-3">RELAY:</strong> a relay candidate, this is basically a TURN
                            <small>(traversal around NAT using relay networks)</small> server borrowing you its public
                            IP address and port, you can use it by sending data there through a tunnel
                        <li class="fw-color-smoke-700"><strong class="indent-3">PRFLX:</strong> peer reflexive - a
                            candidate obtained by asking another player, already connected to, where they see the
                            request coming from - allows connection e.g. within autonomous systems, other WANs, without
                            using the internet
                    </ul>

                    <p>So in step 1, your adapter wil gather all possible candidates, e.g.</p>
                    <ul class="plain">
                        <li><strong class="indent-2">host</strong> <code>192.168.0.10:6120</code> (your local IPv4)
                        <li><strong class="indent-2">host</strong> <code>[fe80::2d5d:1a01:9e2b:4ac1]:6121</code> (your
                            local
                            IPv6)
                        <li><strong class="indent-2">srflx</strong> <code>1.2.3.4:6122</code> (your public IP)
                        <li><strong class="indent-2">relay</strong> <code>116.202.155.226:12345</code> (faforever.com
                            relay)
                    </ul>
                    <p>It will then send those to the other peer and receive their candidate list (analogous, step 2 and
                        3).</p>

                    <p> It will then open a ton of sockets and start talking to the other side (4-7). When it reaches
                        someone, it will attempt to communicate, and then establish connection on the preferred pair, an
                        example list of pairs:</p>
                    <ul class="plain">
                        <li>host<->host
                        <li>host<->host
                        <li>srflx<->host
                        <li>host<->srlfx
                        <li>relay<->srlfx
                        <li>relay<->relay
                    </ul>

                    <p>A relay connection will <strong>always</strong> succeed, therefore <strong>in theory</strong> the
                        adapter should always be able to connect.</p>

                    <p><em>Side note for developers: One adapter is in offerer mode, the other in answerer mode. Game
                        host
                        is
                        always offerer. Offerer sends candidates first, decides on the chosen candidate pair and
                        monitors
                        the connection.</em></p>
                </fw-accordion-body>
            </fw-accordion>
        </div>

        <div class="wrapper">
            <fw-accordion>
                <fw-accordion-title>What is a Coturn server?</fw-accordion-title>
                <fw-accordion-body class="explanation">
                    <p>The FAF ICE adapter aims at managing all connections for the game. It's a program running on your
                        local system started/stopped by the FAF client that offers an interface to the game. The game is
                        then told by the FAF server/client/adapter to connect to other players, supplying it a wrong IP
                        address. If you then join a FAF game, your game will think all of your peers it's connected to
                        are
                        located on your local machine. It sends all its traffic to the ice adapter, which then figures
                        out
                        how to forward it to the other players' ice adapters, which then forward it to their games.</p>

                    <p>The ICE adapter uses the <strong>Interactive Connectivity Establishment</strong> (ICE,
                        standardized
                        as per <a href="https://datatracker.ietf.org/doc/html/rfc5245" target="_blank">RFC5254</a>) to,
                        well, interactively establish connections.</p>
                </fw-accordion-body>
            </fw-accordion>
        </div>
    </main>
    <footer>
        <a href="https://www.faforever.com">powered by FAForever.com</a>
        <ul>
            <li><a target="_blank" href="https://discord.com/invite/hgvj6Af"><i class="fab fa-discord"
                                                                                aria-label="FAF Discord"></i></a>
            </li>
            <li><a target="_blank" href="https://www.youtube.com/c/ForgedAllianceForever"><i class="fab fa-youtube"
                                                                                             aria-label="FAF Youtube"></i></a>
            </li>
            <li><a target="_blank" href="https://www.facebook.com/ForgedAllianceForever"><i class="fab fa-facebook"
                                                                                            aria-label="FAF Facebook"></i></a>
            </li>
            <li><a target="_blank" href="https://github.com/FAForever/"><i class="fab fa-github"
                                                                           aria-label="FAF Github"></i></a></li>
            <li><a target="_blank" href="https://www.patreon.com/faf"><i class="fab fa-patreon"
                                                                         aria-label="FAF Patreon"></i></a></li>
        </ul>
    </footer>
</div>
<script type="application/javascript">
    const timeFormatter = new Intl.RelativeTimeFormat('en', {style: 'long', numeric: 'auto'});
    const coturnData = {
        columns: [{
            key: "region",
            text: "Region",
        }, {
            key: "host",
            text: "Host",
        }, {
            key: "port",
            text: "Port",
            textAlign: "center",
        }, {
            key: "averageRtt",
            text: "Average RTT",
            textAlign: "right",
            formatData: (milliseconds) => {
                return milliseconds == null ? "n/a" : milliseconds + ' ms';
            },
        }],
        rows: [{
            region: "Europe",
            host: "coturn-eu-1.supcomhub.org",
            port: 3478
        }, {
            region: "Europe",
            host: "faforever.com",
            port: 3478
        },]
    }

    const coturnTable = document.getElementById('coturn-table');
    coturnTable.columns = coturnData.columns;
    coturnTable.rows = coturnData.rows;

    const peerData = {
        columns: [{
            key: "id",
            text: "Player ID",
            textAlign: "center",
        }, {
            key: "login",
            text: "Player Name",
        }, {
            key: "connected",
            text: "Connected",
            "variant": "icon",
            textAlign: "center",
        }, {
            key: "localOffer",
            text: "Local Offer",
            "variant": "icon",
            textAlign: "center",
        }, {
            key: "state",
            text: "State",
        }, {
            key: "averageRtt",
            text: "Average RTT",
            textAlign: "right",
            formatData: (milliseconds) => {
                return milliseconds == null ? "n/a" : milliseconds + ' ms';
            }
        }, {
            key: "lastReceived",
            text: "Last Received",
            textAlign: "center",
            formatData: (milliseconds) => {
                if (milliseconds == null) {
                    return "n/a";
                }
                return timeFormatter.format(-Math.floor(milliseconds / 100.0) / 10, 'seconds');
            }
        }, {
            key: "localCandidate",
            text: "Local Candidate",
            textAlign: "center",
        }, {
            key: "remoteCandidate",
            text: "Remote Candidate",
            textAlign: "center",
        }],
        rows: [{
            id: "14",
            login: "Brutus5000",
            connected: {"name": "check"},
            localOffer: {"name": "check"},
            state: "completed",
            averageRtt: 31,
            lastReceived: 1553,
            localCandidate: "prflx",
            remoteCandidate: "host",
        }, {
            id: "2345",
            login: "Askaholic",
            connected: {"name": "wifi-unavailable"},
            localOffer: {"name": "check"},
            state: "awaitingCandidates",
            averageRtt: null,
            lastReceived: 15253,
            localCandidate: "stun",
            remoteCandidate: "prflx",
        }, {
            id: "3456",
            login: "Giebmasse",
            connected: {"name": "check"},
            localOffer: {"name": "check"},
            state: "connected",
            averageRtt: 67,
            lastReceived: 753,
            localCandidate: "local",
            remoteCandidate: "host",
        }]
    };

    const peerTable = document.getElementById('connections-table');
    peerTable.columns = peerData.columns;
    peerTable.rows = peerData.rows;
</script>
</body>
</html>